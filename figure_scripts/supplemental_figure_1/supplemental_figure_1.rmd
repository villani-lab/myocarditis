---
title: "Supplemental Figure 1"
output: rmarkdown::github_document
---


## Set up

Load R libraries
```{r message=FALSE, load_r_libraries}
library(reticulate)
library(tidyverse)
library(rmarkdown)
library(rlang)
library(parameters)
library(RColorBrewer)
library(ComplexHeatmap)
library(circlize)
library(Matrix)
library(glue)
library(fgsea)
library(ggforestplot)
library(ggbeeswarm)
library(patchwork)
library(lme4)
library(ggstance)
library(knitr)
library(grid)
library(readxl)
library(ggpubr)

setwd('/projects/home/ikernin/github_code/myocarditis/functions')
source('de.R')
source('gsea.R')
source('masc.R')
source('plot_masc.R')
source('blood_abundance.R')
source('blood_troponin.R')

use_python("/projects/home/nealpsmith/.conda/envs/updated_pegasus/bin/python")
wd = '/projects/home/sramesh/github/myocarditis'
```

Load Python packages
```{python message=FALSE, load_python_packages}
import pandas as pd
import pegasus as pg
import os
import sys
import warnings

sys.path.append("/projects/home/ikernin/github_code/myocarditis/functions")
import python_functions

sys.path.append("/projects/home/sramesh/github/myocarditis/functions")
import python_functions as pyfun

wd = '/projects/home/sramesh/github/myocarditis'
warnings.filterwarnings('ignore')
```

Read in single-cell data and cluster names
```{python message = F, results = F, python_read_data}
# read tissue data
tissue_global = pg.read_input('/projects/home/ikernin/projects/myocarditis/updated_datasets/tissue_all_with_dcs.zarr')

# read blood data
adata = pg.read_input('/projects/home/sramesh/myo_final/blood/final/myo_blood_global.zarr')
cluster_annots = pd.read_excel('/projects/home/sramesh/myo_final/blood/other_stuff/cluster_annotations.xlsx')
name_dict = dict(zip(cluster_annots['lineage_cluster_mod'], cluster_annots['cluster_name_w_num']))
```

```{r message = F, results = 'hold', read_data_r}
# read tissue data
tissue_global_obs <- read_csv('/projects/home/ikernin/projects/myocarditis/updated_datasets/metadata/tissue_full_obs.csv')

# read blood data
obs <- read_csv('/projects/home/sramesh/myo_final/blood/final/myo_blood_global_obs.csv')
cluster_annots <- readxl::read_excel('/projects/home/sramesh/myo_final/blood/other_stuff/cluster_annotations.xlsx')
```

## Supplemental Figure 1A

```{python supp_1a}
python_functions.make_gene_dotplot(tissue_global.to_anndata(),
             cluster_order=['Endothelial cells', 'cDC', 'pDC',
                            'Myeloid cells', 'B and plasma cells',
                            'T and NK cells', 'Cardiomyocytes', 'Mural cells',
                            'Fibroblasts',
                            'Neuronal cells'
                            ],
             gene_order=['VWF', 'AQP1', 'CA4', 'HEY1', 'HLA-DQA1', 'CD1C',
                         'CLEC9A', 'LILRA4', 'IL3RA', 'CD14', 'CD68', 'C1QA', 'FCGR3A',
                         'CD79A', 'MZB1', 'MS4A1', 'CD3D', 'CD8A', 'KLRB1', 'TNNI3',
                         'MB', 'RGS5', 'MYH11', 'KCNJ8', 'ACTA2', 'DCN',
                         'PDGFRA', 'PLP1', 'NRXN1'],
             title='All Cells'
             )
```


## Supplemental Figure 1B

```{r supp_1b}
p_1b <- ggplot(tissue_global_obs, aes(y = umap_name, fill = institution)) +
  geom_bar(position = 'fill') +
  scale_fill_manual(values = c('#0273b5', '#e18728')) +
  scale_x_continuous(labels = scales::percent,
                     expand = c(0,0),
                     limits = c(0,1)) +
  theme_classic()
print(p_1b)
```

## Supplemental Figure 1C

```{r supp_1c}
melanoma <- c("SIC_171",
              "SIC_182",
              "SIC_237",
              "SIC_319")

renal <- c("SIC_197",
           "SIC_199",
           "SIC_217",
           "SIC_232",
           "SIC_317")

other <- c("SIC_48",
           "SIC_153",
           "SIC_164",
           "SIC_175",
           "SIC_177",
           "SIC_258",
           "SIC_264",
           "SIC_333")
non_sanger <- unique(tissue_global_obs$donor)[!str_detect(unique(tissue_global_obs$donor), 'Sanger')]

p_1c <- tissue_global_obs %>%
  filter(donor %in% non_sanger) %>%
  filter(condition == 'myocarditis') %>%
  filter(on_steroids == 'False') %>%
  mutate(tumor_type = case_when(
    donor %in% melanoma ~ 'Melanoma',
    donor %in% renal ~ 'Renal Cell',
    donor %in% other ~ 'Other',
    TRUE ~ "N/A"
  )) %>%
  ggplot(aes(y = donor, fill = umap_name)) +
  geom_bar(position = 'fill') +
  scale_fill_manual(values = c(
    "#b3e900", # b and plasma
    "#ff7f00", # cardiomyocytes
    "#7f80cd", # cDC
    "#f781bf", # doublets
    "#ff0029", # endothelial
    "#00d2d5", # fibroblast
    "#377eb8", # mural
    "#984ea3", # mnp
    "#af8d00", # neuronal
    "#c42e60", # pdf
    '#66a61e' # t and nk

  )) +
  scale_x_continuous(labels = scales::percent,
                     expand = c(0,0),
                     limits = c(0,1)) +
  scale_y_discrete(position = "right") +
  facet_grid(tumor_type ~ ., scales = 'free_y', space = 'free', switch = 'y') +
  theme_classic() +
  labs(
    x = '% of donor cells',
    y = element_blank(),
    fill = 'Lineage'
  )
print(p_1c)
```

## Supplemental Figure 1D

```{r supp_1d, message = FALSE, warning = FALSE}

abund_data <- read_excel("/projects/home/nealpsmith/projects/myocarditis/data/updated_supplemental_tables/abundance_analysis_aggregated.xlsx",
                         sheet = "masc_res")

tissue_data <- abund_data %>%
  dplyr::filter(tissue == "heart")

withmets <- tissue_data %>%
  dplyr::filter(contrast == "irMyocarditis vs. control") %>%
  dplyr::select(cluster, OR) %>%
  `colnames<-`(c("cluster", "OR_mets"))

nomets <- tissue_data %>%
  dplyr::filter(contrast == "irMyocarditis vs. control without heart metastasis") %>%
  dplyr::select(cluster, OR) %>%
  `colnames<-`(c("cluster", "OR_nomets"))

plot_df <- left_join(withmets, nomets, by = "cluster") %>%
  dplyr::filter(cluster != "h-pDC: LILRA4 IRF8")

ggplot(plot_df, aes(x = OR_mets, y = OR_nomets)) +
  geom_point(size = 3) +
  scale_x_log10() +
  scale_y_log10() +
  geom_abline() +
  geom_vline(xintercept = 1) +
  geom_hline(yintercept = 1) +
  ylab("OR : without cardiac metastases") +
  xlab("OR : all samples") +
  theme_classic(base_size = 20)
```

## Supplemental Figure 1E
```{r supp_1e, message = F}
all_data <- read.csv("/projects/home/nealpsmith/projects/myocarditis/data/supplemental_tables/all_degs_concatenated.csv")
tcell_no_mm <- read.csv("/projects/home/nealpsmith/projects/myocarditis/data/t_no_micromets_de_by_condition_all_results.csv")
tcell_no_mm$X <- NULL
tcell_no_mm$cluster <- NULL
colnames(tcell_no_mm) <- c(paste("no_mm", colnames(tcell_no_mm)[1:6], sep = "_"), "gene_symbol", "cluster")


### MNP ###
mnp_no_mm <- read.csv("/projects/home/nealpsmith/projects/myocarditis/data/myeloid_no_micromets_de_by_condition_all_results.csv")
mnp_no_mm$X <- NULL
mnp_no_mm$cluster <- NULL
colnames(mnp_no_mm) <- c(paste("no_mm", colnames(mnp_no_mm)[1:6], sep = "_"), "gene_symbol", "cluster")

### Non-immune ###
nonimmune_no_mm <- read.csv("/projects/home/nealpsmith/projects/myocarditis/data/nonimmune_no_micromets_de_by_condition_all_results.csv")
nonimmune_no_mm$X <- NULL
nonimmune_no_mm$cluster <- NULL
colnames(nonimmune_no_mm) <- c(paste("no_mm", colnames(nonimmune_no_mm)[1:6], sep = "_"), "gene_symbol", "cluster")

### How about one for all DEGs ###
no_mm_data_all <- rbind(tcell_no_mm, mnp_no_mm, nonimmune_no_mm)

plot_degs_all <- all_data %>%
  dplyr::filter(tissue == "heart", padj < 0.1) %>%
  dplyr::left_join(no_mm_data_all, by = c("gene_symbol", "cluster"))

ggplot(plot_degs_all, aes(x = log2FoldChange, y = no_mm_log2FoldChange)) +
  # geom_point(data = plot_degs_all %>% dplyr::filter(label == ""), color = "grey") +
  geom_point(data = plot_degs_all, fill = "black", pch = 21, size = 3) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_abline() +
  ylab("log2FC : without cardiac metastases") +
  xlab("log2FC : with cardiac metastases") +
  # geom_text_repel(aes(label = label), min.segment.length = 0.1, max.overlaps = 100) +
  theme_classic(base_size = 20)

```

## Supplemental Figure 1F

```{r message = FALSE, results = 'hold', fig_1g}

# read in serum values per sample
serum_df <- read_csv('/projects/home/ikernin/projects/myocarditis/updated_datasets/metadata/tidy_serum.csv')

# get between condition statistics for log1p values
serum_model <- serum_df %>%
  dplyr::select(!c(patient, timepoint, Sample)) %>%
  pivot_longer(cols=!c(condition),
               names_to='protein',
               values_to='value') %>%
  mutate(log1p_value = log1p(value)) %>%
  group_by(condition, protein) %>%
  summarize(log1p_values = list(log1p_value)) %>%
  pivot_wider(names_from = condition,
              values_from = log1p_values) %>%
  group_by(protein) %>%
  summarize(mean_case = mean(unlist(myocarditis)),
            std_case = sd(unlist(myocarditis)),
            n_case = length(unlist(myocarditis)),
            mean_control = mean(unlist(control)),
            std_control = sd(unlist(control)),
            n_control = length(unlist(control)),
            p_value = t.test(unlist(control), unlist(myocarditis))$p.value,
            t_stat = t.test(unlist(control), unlist(myocarditis))$statistic,
            log2FC = log2(mean_case/mean_control))
kable(serum_model)

# proteins to annotate in figures
serum_annot <-  c('MIG/CXCL9', 'IP-10', 'TNFα','IFNγ', 'IL-2',
                  'IL-12p40', 'IL-15', 'IL-18', 'IL-27', '6CKine')

# make volcano plot
serum_plot_df <- serum_model %>%
  mutate(
    name = case_when(
      protein %in% serum_annot ~ protein,
      TRUE ~ ""
    ),
    t_stat = -t_stat
  )

ggplot(serum_plot_df, aes(y = -log10(p_value), x = log2FC)) +
  geom_point(data = serum_plot_df %>% filter(t_stat < 0), color =  'slategray', size = 2.5) +
  geom_point(data = serum_plot_df %>% filter(t_stat > 0), color =  'tomato4', size = 2.5) +
  geom_vline(xintercept = 0, lty=2) +
  ggrepel::geom_label_repel(aes(label = name), size = 4) +
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        panel.background = element_blank())
```

## Supplemental Figure 1G

```{r results = 'hold', message = F, supp_1f}
# read in serum values per sample
serum_df <- read_csv('/projects/home/ikernin/projects/myocarditis/updated_datasets/metadata/tidy_serum.csv')

# get between condition statistics for log1p values
serum_model <- serum_df %>%
  select(!c(patient, timepoint, Sample)) %>%
  pivot_longer(cols=!c(condition),
               names_to='protein',
               values_to='value') %>%
  mutate(log1p_value = log1p(value)) %>%
  group_by(condition, protein) %>%
  summarize(log1p_values = list(log1p_value)) %>%
  pivot_wider(names_from = condition,
              values_from = log1p_values) %>%
  group_by(protein) %>%
  summarize(mean_case = mean(unlist(myocarditis)),
            std_case = sd(unlist(myocarditis)),
            n_case = length(unlist(myocarditis)),
            mean_control = mean(unlist(control)),
            std_control = sd(unlist(control)),
            n_control = length(unlist(control)),
            p_value = t.test(unlist(control), unlist(myocarditis))$p.value,
            t_stat = t.test(unlist(control), unlist(myocarditis))$statistic,
            log2FC = log2(mean_case/mean_control))
kable(serum_model)

# proteins to annotate in figures
serum_annot <-  c('MIG/CXCL9', 'IP-10', 'TNFα','IFNγ', 'IL-2',
                  'IL-12p40', 'IL-15', 'IL-18', 'IL-27', '6CKine')

micromet_donors <- c("SIC_136", "SIC_171", "SIC_232", "SIC_182")

# get data for ext fig 1e
ext_1e_df <- serum_df %>%
  select(!c(Sample, timepoint)) %>%
  pivot_longer(cols = !c(patient, condition),
               names_to='protein') %>%
  filter(protein %in% serum_annot) %>%
  left_join(serum_model %>% select(protein, p_value)) %>%
  mutate(
    protein = case_when(
      protein == '6CKine' ~ 'CCL21',
      protein == 'IP-10' ~ 'CXCL10',
      protein == 'MIG/CXCL9' ~ 'CXCL9',
      TRUE ~ protein),
    condition2 =
      case_when(
        patient %in% micromet_donors ~ 'micromet',
        TRUE ~ condition)
    )

ext_1e_labels <- ext_1e_df %>%
  select(protein, p_value) %>%
  mutate(facet_name = str_c(protein, str_c("p=", signif(p_value, 2)), sep = '\n')) %>%
  select(protein, facet_name) %>%
  distinct() %>%
  deframe()


p_1e <- ggplot(ext_1e_df, aes(x = condition, y = value + 1, fill = condition)) +
  geom_boxplot(alpha = 0.6,
               outlier.shape = NA) +
  geom_jitter(aes(fill = condition2,
                  size = condition2 == 'micromet'),
              shape=21) +
  scale_y_log10()+
  scale_color_manual(values = c('slategray', 'tomato4')) +
  scale_fill_manual(values = c('slategray', 'yellow', 'tomato4')) +
  scale_size_manual(values = c(1,3)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  guides(size = "none") +
  facet_wrap(~protein,
             labeller = labeller(protein = ext_1e_labels),
             scales = 'free_y',
             nrow=2) +
  labs(fill = 'Condition',
       color = 'Condition',
       x = element_blank(),
       y = "pg/mL + 1")
print(p_1e)
```

## Supplemental Figure 1H


```{r supp_1h, message = FALSE, warning = FALSE}

serum_data <- read.csv("/projects/home/nealpsmith/projects/myocarditis/data/updated_supplemental_tables/all_serum_stats.csv")

withmets <- serum_data %>%
  dplyr::filter(contrast == "irMyocarditis vs. control with mets") %>%
  dplyr::select(protein, t_statistic) %>%
  `colnames<-`(c("protein", "t_stat_mets"))

nomets <- serum_data %>%
  dplyr::filter(contrast == "irMyocarditis vs. control without mets") %>%
  dplyr::select(protein, t_statistic) %>%
  `colnames<-`(c("protein", "t_stat_nomets"))

plot_df <- left_join(withmets, nomets, by = "protein")

ggplot(plot_df, aes(x = -t_stat_mets, y = -t_stat_nomets)) +
  geom_point(size = 3) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_abline() +
  ylab("T-statistic : without cardiac metastases") +
  xlab("T-statistic : all samples") +
  theme_classic(base_size = 20)

```

## Supplemental figure 1I

```{python results = 'hold', supp_1i}
cluster_order = ['pDCs', 'B and plasma', 'cDCs', 'CD4', 'MNP', 'CD8 and NK']
gene_order = ['LILRA4', 'IL3RA', 'CD79A', 'MS4A1', 'JCHAIN', 'CD1C', 'CLEC10A', 'CLEC9A', 'CD4', 'CD3D', 'IL7R', 'LYZ',
              'CD14', 'AIF1', 'CD8A', 'NKG7', 'KLRF1']
pyfun.make_gene_dotplot(adata.to_anndata(), cluster_order, gene_order, 'All cells', figsize=(5, 4), names='lineage')
```

## Supplemental Figure 1J
```{r message = F, warning = F, results = 'hold', fig.width = 14, fig.height = 7, supp_1j}
# run masc for pre- vs post-steroid by lineage (or read in file if it exists)
if (!file.exists(glue('{wd}/output/masc_for_steroid_treatment_by_lineage.csv'))) {
  lineage_masc_res <- run_masc(obs,
                               c('steroid_treatment', 'post_steroid', 'pre_steroid'),
                               'lineage')
  write_csv(lineage_masc_res, glue('{wd}/output/masc_for_steroid_treatment_by_lineage.csv'))
} else {
  lineage_masc_res <- read_csv(glue('{wd}/output/masc_for_steroid_treatment_by_lineage.csv'))
}

lineage_masc_res$lineage <- str_replace_all(lineage_masc_res$lineage, '_', ' ')

masc_helper(obs,
            c('steroid_treatment', 'post_steroid', 'pre_steroid'),
            'lineage',
            masc_res = lineage_masc_res,
            colors = c('darkolivegreen4', 'darkolivegreen2'))
```

## Supplemental Figure 1K
```{r message = F, results = 'hold', warning = F, fig.width = 7, fig.height = 7, supp_1k}
#### first run de
if (!file.exists(glue('{wd}/output/lineage_de_by_steroid_treatment_all_results.csv'))) {
  counts <- read_counts(glue("{wd}/output/pb_counts_by_sample_id_and_lineage.csv"))
  meta <- read_meta(glue("{wd}/output/pb_meta_by_sample_id_and_lineage.csv"))
  meta <- meta %>%
    filter(steroid_treatment != "NA") %>%
    filter(!str_detect(lineage, "Doublet"))
  steroid_contrast_vec <- c('steroid_treatment', 'pre_steroid', 'post_steroid')
  steroid_lineage_results <- run_de_by_comp_var(counts, meta, glue('{wd}/output/lineage'), steroid_contrast_vec,
                                                deseq_formula = formula("~ steroid_treatment"))
} else {
  steroid_lineage_results <- read_csv(glue('{wd}/output/lineage_de_by_steroid_treatment_all_results.csv'))
}

#### now plot barplot
colors <- c('darkolivegreen2', 'darkolivegreen4')
cluster_order <- c('pDCs', 'B and plasma', 'cDCs', 'CD4', 'MNP', 'CD8 and NK')
res <- steroid_lineage_results %>%
  mutate(cluster = str_replace_all(cluster, '_', ' '))
res <- res[res$padj < 0.1, ]
ups <- downs <- numeric(length(cluster_order))

for (i in seq_along(cluster_order)) {
  clust <- cluster_order[i]
  up_genes <- res[res$cluster == clust & res$log2FoldChange > 0, ]
  down_genes <- res[res$cluster == clust & res$log2FoldChange < 0, ]
  ups[i] <- nrow(up_genes)
  downs[i] <- -nrow(down_genes)
}

df <- data.frame(cluster = cluster_order, up = ups, down = downs)
df <- df %>% mutate(cluster = factor(cluster, levels = rev(cluster_order)))

ggplot(df, aes(x = up, y = cluster)) +
  geom_bar(stat = "identity", fill = colors[1]) +
  geom_bar(stat = "identity", aes(x = down, y = cluster), fill = colors[2]) +
  geom_vline(xintercept = 0, color = "black", linetype = "solid", size = 0.5) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        text = element_text(size = 16),
        axis.text = element_text(color = 'black')) +
  labs(x = element_blank(),
       y = element_blank())
```

## Supplemental figure 1L

## Supplemental figure 1M
```{r supp_1m, message = F, results = 'hold', warning = F, fig.width = 10, height = 12}

plot_info <- read.csv("/projects/home/nealpsmith/projects/myocarditis/swimmer_plot/swimmer_plot_info.csv")

# Need to figure out how long to make the line for everyone
plot_info$end_line <- apply(plot_info, 1, function(d){
  if (!is.na(d[["post_steroid_samp_day"]])){
    return(as.numeric(d[["post_steroid_samp_day"]]) - as.numeric(d[["ici_start_day"]]))
  } else {
    return(as.numeric(d[["steroid_start_day"]]) - as.numeric(d[["ici_start_day"]]))
  }
})
plot_info$days_to_steroid <-  plot_info$steroid_start_day - plot_info$ici_start_day
plot_info$days_to_post_steroid <-plot_info$post_steroid_samp_day - plot_info$ici_start_day
plot_df <- plot_info %>%
  dplyr::select(ID, time_ici_to_pre_steroid_samp, time_pre_steroid_samp_to_steroid,
                time_steroid_start_to_post_steroid_samp,days_to_steroid, days_to_post_steroid, end_line)
# Lets get the rows ordered
fatal_ids <- c("SIC_3", "SIC_17", "SIC_175", "SIC_232", "SIC_264", "SIC_266")
plot_df$fatal <- ifelse(plot_df$ID %in% fatal_ids, "fatal", "non-fatal")
plot_df$has_pre <- ifelse(is.na(plot_df$time_ici_to_pre_steroid_samp), "no", "yes")

order <- plot_df %>%
  arrange(desc(has_pre), fatal) %>%
  .$ID
plot_df$ID <- factor(plot_df$ID, levels = rev(order))

brewer.pal(4, "Set1")

plot_info$steroid_to_pre_steroid <- plot_info$pre_steroid_samp_day - plot_info$steroid_start_day
# Time from steroid to post-steroid samp
plot_info$steroid_to_post_steroid <- plot_info$post_steroid_samp_day - plot_info$steroid_start_day

plot_df <- plot_info %>%
  dplyr::select(ID, steroid_to_pre_steroid, steroid_to_post_steroid) %>%
  mutate("steroid_start" = 0)
plot_df$start_point <- ifelse(is.na(plot_df$steroid_to_pre_steroid), 0, (plot_df$steroid_to_pre_steroid))
plot_df$end_point <- ifelse(is.na(plot_df$steroid_to_post_steroid), 0, (plot_df$steroid_to_post_steroid))

# Lets get the rows ordered
fatal_ids <- c("SIC_3", "SIC_17", "SIC_175", "SIC_232", "SIC_264", "SIC_266")
plot_df$fatal <- ifelse(plot_df$ID %in% fatal_ids, "fatal", "non-fatal")
plot_df$has_pre <- ifelse(is.na(plot_df$steroid_to_pre_steroid), "no", "yes")
plot_df$has_post <- ifelse(is.na(plot_df$steroid_to_post_steroid), "no", "yes")
order <- plot_df %>%
  arrange(desc(has_post), fatal,steroid_to_post_steroid ) %>%
  .$ID
plot_df$ID <- factor(plot_df$ID, levels = rev(order))

# Lets add a table next to it with peak troponin
trop_info <- read.csv("/projects/home/nealpsmith/projects/myocarditis/post_steroid_trop/data/post_steroid_trop_data.csv")
trop_info$ID <- sapply(trop_info$sample, function(x) paste(strsplit(x, "_")[[1]][1:2], collapse = "_"))
trop_info$sample <- NULL
trop_info$trop_fc <-((trop_info$Peak.troponin- trop_info$post_steroid_troponin)/ trop_info$Peak.troponin) * 100

# Get the missing ones as well
trop_no_post <- read.csv("/projects/home/nealpsmith/projects/myocarditis/post_steroid_trop/data/no_pre_steroid_peak_trop.csv")
trop_no_post$post_steroid_troponin <- NA
trop_no_post$trop_fc <- NA
trop_no_post <- trop_no_post %>%
  dplyr::select(colnames(trop_info))

trop_info <- rbind(trop_info, trop_no_post)
trop_info$ID <- factor(trop_info$ID, levels = levels(plot_df$ID))

p1 <- ggplot(plot_df, aes(x = value, y = ID)) +
  geom_stripes(aes(x = NULL), odd = "#ffffff00", even = "#33333333") +
  geom_segment(aes(x=start_point, xend=end_point, y=ID, yend=ID)) +
  geom_point(x = 0, size = 4, (aes(color = "Steroid treatment")), alpha = 0.9) +
  geom_point(x = plot_df$steroid_to_pre_steroid, size = 4, pch = 17,aes(color = "Pre-steroid sample"), alpha = 0.9) +
  geom_point(x = plot_df$steroid_to_post_steroid, size = 4, pch = 18, aes(color = "Post-steroid sample"), alpha = 0.9) +
  scale_color_manual(name = "",
                     values = c("Steroid treatment" = "#E41A1C", "Pre-steroid sample" = "#377EB8", "Post-steroid sample" = "#984EA3"),
                     breaks = c("Steroid treatment", "Pre-steroid sample", "Post-steroid sample")) +
  scale_shape_manual(name = "",
                   values = c("Steroid treatment" = 16, "Pre-steroid sample" = 17, "Post-steroid sample" = 18),
                   breaks = c("Steroid treatment", "Pre-steroid sample", "Post-steroid sample")) +
  xlab("Days") +
  theme_classic(base_size = 20)

all(levels(trop_info$ID) == levels(plot_df$ID))

p2 <- ggplot(trop_info, aes(x = 1, y = ID)) +
  geom_tile(fill = NA, color = "black", size = 1) +
  geom_text(aes(label = Peak.troponin)) +
  ggtitle("Peak troponin") +
  geom_stripes(odd = "#ffffff00", even = "#33333333") +
  theme_void()
p3 <- ggplot(trop_info, aes(x = 1, y = ID)) +
  geom_tile(fill = NA, color = "black", size = 1) +
  geom_text(aes(label = round(trop_fc, 2))) +
  ggtitle("% Troponin reduction") +
  geom_stripes(odd = "#ffffff00", even = "#33333333") +
  theme_void()

ggarrange(p1, p2, p3, widths = c(0.8, 0.15, 0.15), align = "h", nrow = 1, common.legend = TRUE)

```

## Supplemental figure 1N
```{r supp_1n, message = F, results = 'hold', warning = F, fig.width = 7, fig.height = 7}


mtx <- read.csv("/projects/home/sramesh/github/myocarditis/output/pb_counts_by_sample_id_and_lineage.csv",
                row.names = 1)

norm_counts <- apply(mtx, 2, function(c){
  n_total <- sum(c)
  per_100k <- (c * 1000000) / n_total
  return(per_100k)
})

norm_counts <- log1p(norm_counts)

meta <- read.csv("/projects/home/sramesh/github/myocarditis/output/pb_meta_by_sample_id_and_lineage.csv",
                 row.names = 1)
meta$donor <- sapply(meta$sample, function(x) paste(strsplit(x, "_")[[1]][1:2], collapse = "_"))

trop_meta <- read.csv("/projects/home/nealpsmith/projects/myocarditis/post_steroid_trop/data/post_steroid_trop_data.csv")
trop_meta$trop_fc <-(trop_meta$Peak.troponin- trop_meta$post_steroid_troponin)/ trop_meta$Peak.troponin
trop_meta$trop_logfc <- log1p(trop_meta$trop_fc)

# Also need to add time from steroid start to post-steroid sample
time_info <- read.csv("/projects/home/nealpsmith/projects/myocarditis/swimmer_plot/swimmer_plot_info.csv")
time_info %<>%
  dplyr::select(ID, time_steroid_start_to_post_steroid_samp) %>%
  dplyr::rename(donor = ID)

meta %<>%
  rownames_to_column() %>%
  dplyr::left_join(trop_meta, by = "sample") %>%
  dplyr::left_join(time_info, by = "donor") %>%
  column_to_rownames("rowname")
meta$log_time_steroid_start_to_post_steroid_samp <- log1p(meta$time_steroid_start_to_post_steroid_samp)
# Need to fix SIC_3
rownames(meta)[grepl("SIC_3_", rownames(meta))] <- sub("-", ".", rownames(meta)[grepl("SIC_3_", rownames(meta))])
ps_meta <- meta %>%
  dplyr::filter(sample %in% trop_meta$sample)
ps_mtx <- mtx[,rownames(ps_meta)]

if (!file.exists("/projects/home/nealpsmith/projects/myocarditis/post_steroid_trop/data/all_deg_res.csv")){
  # Iterate across lineages
  gene_sets <-  gmtPathways( "/projects/home/nealpsmith/projects/medoff/data/msigdb_symbols.gmt")
  n_gene_df <- data.frame()
  deg_res <- data.frame()
  gsea_res <- data.frame()

  for(lin in unique(ps_meta$lineage)){

    if (lin == "Doublets_and_RBCs"){
      next()
    }

    meta_temp <- ps_meta[ps_meta$lineage == lin,]
    meta_temp$post_steroid_fatal <- factor(meta_temp$post_steroid_fatal, levels = c("non_fatal", "fatal"))
    count_temp <- ps_mtx[,rownames(meta_temp)]

    # Make sure the genes are detected in enough samples
    n_samp <- rowSums(count_temp != 0)
    count_temp <- count_temp[n_samp > round(nrow(meta_temp) / 2),]

    models <- c(as.formula("~log_time_steroid_start_to_post_steroid_samp+trop_logfc"),
                as.formula("~trop_logfc+log_time_steroid_start_to_post_steroid_samp"),
                as.formula("~post_steroid_fatal"))
    for (m in models){
      test_var <- tail(strsplit(as.character(m), "+", fixed = TRUE)[[2]], n = 1)
      test_var <- gsub(" ", "", test_var)

      dds <- DESeqDataSetFromMatrix(countData = count_temp,
                                colData = meta_temp,
                                design = m)
      dds <- DESeq(dds)
      res <- as.data.frame(results(dds))
      res <- res[!is.na(res$padj),]
      res$contrast <- test_var
      res$lin <- lin
      res$gene <- rownames(res)
      deg_res <- rbind(deg_res, res)

      n_up <- nrow(res[res$padj < 0.1 & res$log2FoldChange > 0,])
      n_down <- nrow(res[res$padj < 0.1 & res$log2FoldChange < 0,])
      df <- data.frame(lin = lin, contrast = test_var, n_up = n_up, n_down = n_down)
      n_gene_df <- rbind(n_gene_df, df)

      ## GSEA ##
      order_genes <- res %>%
        dplyr::select(gene, stat) %>%
        na.omit() %>%
        distinct() %>%
        group_by(gene) %>%
        summarize(stat=mean(stat))
      ranks <- deframe(order_genes)

      for (geneset in c("BIOCARTA", "HALLMARK", "KEGG")){
        gsets <- gene_sets[grep(geneset, names(gene_sets))]
        fgseaRes <- fgsea(pathways=gsets, stats=ranks, nperm=10000)
        fgseaResTidy <- fgseaRes %>%
          as_tibble() %>%
          arrange(desc(NES))
        fgseaResTidy$contrast <- test_var
        fgseaResTidy$lin <- lin
        fgseaResTidy$library <- geneset
        gsea_res <- rbind(gsea_res, fgseaResTidy)

        }
      }
    }
    gsea_res$leadingEdge <- as.character(gsea_res$leadingEdge)

    # Write the results
    write.csv(deg_res, "/projects/home/nealpsmith/projects/myocarditis/post_steroid_trop/data/all_deg_res.csv")
    write.csv(gsea_res, "/projects/home/nealpsmith/projects/myocarditis/post_steroid_trop/data/all_gsea_res.csv")

} else {
  deg_res <- read.csv("/projects/home/nealpsmith/projects/myocarditis/post_steroid_trop/data/all_deg_res.csv",
                      row.names = 1)
  gsea_res <- read.csv("/projects/home/nealpsmith/projects/myocarditis/post_steroid_trop/data/all_gsea_res.csv",
                       row.names = 1)
}

var <- "log_time_steroid_start_to_post_steroid_samp"
plot_df <-deg_res %>%
  dplyr::filter(contrast == var, padj < 0.1) %>%
  mutate(variable = ifelse(log2FoldChange > 0, "n_up", "n_down")) %>%
  group_by(lin, variable) %>%
  summarise(value = n()) %>%
  mutate(value = ifelse(variable == "n_down", -value, value))

ggplot(plot_df, aes(x = lin, y = value, group = variable, fill = variable)) +
  geom_bar(stat = "identity") + coord_flip() +
  scale_fill_manual(values = c("#FF0000", "#0000FF")) +
  scale_y_continuous(labels = abs, limits = c(-1500, 1750)) +
  ylab("# of DE genes") + xlab("") +
  ggtitle(glue("model by {var}")) +
  theme_classic(base_size = 15)

```

```{r supp_1o, message = F, results = 'hold', warning = F, fig.width = 7, fig.height = 7}
pathways <- c('KEGG_ALLOGRAFT_REJECTION', 'KEGG_ANTIGEN_PROCESSING_AND_PRESENTATION',
              'KEGG_CELL_ADHESION_MOLECULES_CAMS', 'KEGG_DNA_REPLICATION',
              'HALLMARK_INTERFERON_GAMMA_RESPONSE',
              'KEGG_VIRAL_MYOCARDITIS')
pathway_abbrevs <- c('KEGG: Allo', 'KEGG: AP', 'KEGG: CAMS', 'KEGG: DNA', 'HALLMARK: IFNG', 'KEGG: Viral Myo')
abbrev_dict <- setNames(pathway_abbrevs, pathways)
lineage_order <- c('pDCs', 'cDCs', 'B and plasma', 'MNP', 'CD4', 'CD8 and NK')
c <- "log_time_steroid_start_to_post_steroid_samp"
c_data <- gsea_res %>%
dplyr::filter(contrast == c)

heatmap_df <- c_data %>%
complete(pathway, lin) %>%
replace_na(list(log2FoldChange = 0, padj = 1)) %>%
dplyr::select(pathway, lin, NES, padj) %>%
filter(pathway %in% pathways) %>%
mutate(cluster = str_replace_all(lin, '_', ' ')) %>%
mutate(pathway = abbrev_dict[pathway])

nes_mtx <- heatmap_df %>%
dplyr::select(c(pathway, cluster, NES)) %>%
pivot_wider(names_from = cluster, values_from = NES) %>%
column_to_rownames('pathway') %>%
dplyr::select(all_of(lineage_order)) %>%
as.matrix()
nes_mtx <- nes_mtx[pathway_abbrevs,] %>% t()

# define cell color range
heatmap_col_fun <- colorRamp2(c(floor(min(nes_mtx, na.rm = T)), 0, ceiling(max(nes_mtx, na.rm = T))),
                            brewer.pal(5, 'PiYG')[c(5,3,1)])

fdr_mtx <- heatmap_df %>%
dplyr::select(c(pathway, cluster, padj)) %>%
pivot_wider(names_from = cluster, values_from = padj) %>%
column_to_rownames('pathway') %>%
dplyr::select(all_of(lineage_order)) %>%
as.matrix()
fdr_mtx <- fdr_mtx[pathway_abbrevs,] %>% t()

# make function for plotting fdr value (this function returns a function)
fdr_func <- function(mtx) {
function(j, i, x, y, width, height, fill) {
  if (!is.na(mtx[i, j]) & (mtx[i,j] < 0.1)) {
    grid.circle(x = x, y = y, r = unit(1.5, 'mm'),
                gp = gpar(fill = 'black', col = NA))
  }
}
}

# make sure columns are the same
stopifnot(colnames(fdr_mtx) == colnames(nes_mtx))
stopifnot(rownames(fdr_mtx) == rownames(nes_mtx))

gsea_lgd <- Legend(col_fun = heatmap_col_fun, title = 'NES', direction = 'horizontal')
fdr_lgd <- Legend(pch = 16, type = "points", labels = "FDR < 0.1")
na_lgd <- Legend(labels = 'N/A', legend_gp = gpar(fill = 'grey'))
pd <- packLegend(gsea_lgd, fdr_lgd, na_lgd, direction = 'horizontal')

ht_gsea <- Heatmap(nes_mtx,
                 col = heatmap_col_fun,
                 cell_fun = fdr_func(fdr_mtx),
                 column_order = colnames(nes_mtx),
                 top_annotation = NULL, column_title = c,
                 name = 'NES', show_heatmap_legend = FALSE,
                 cluster_columns = FALSE, column_names_side = "top",
                 show_column_names = T, column_names_rot = 45,
                 cluster_rows = FALSE, row_names_side = "left",
                 row_title_rot = 0, row_title_gp=gpar(fontface='bold'),
                 row_gap = unit(2, "mm"), border = TRUE,
                 width = ncol(nes_mtx)*unit(6, "mm"),
                 height = nrow(nes_mtx)*unit(6, "mm"))

draw(ht_gsea,
   heatmap_legend_list = pd,
   heatmap_legend_side = 'bottom',
   merge_legends = FALSE)


```