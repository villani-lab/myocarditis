---
title: "Supplementary Figure 7"
output: rmarkdown::github_document
---


## Setup

Load R libraries
```{r message=FALSE}
## load required R packages
library(tidyverse)
library(glue)
library(RColorBrewer)
library(reticulate)
use_python("/projects/home/nealpsmith/.conda/envs/updated_pegasus/bin/python")

setwd('/projects/home/ikernin/github_code/myocarditis/functions')
source('stacked_bar.R')
```

Load Python packages
```{python load_python_packages}
import pegasus as pg
import scanpy as sc
import warnings
warnings.filterwarnings('ignore')

import sys
sys.path.append("/projects/home/ikernin/github_code/myocarditis/functions")
import python_functions
```

Read in single-cell data
```{python results = 'hide', read_data}
tissue_nonimmune = pg.read_input('/projects/home/ikernin/projects/myocarditis/github_datasets/tissue_nonimmune.zarr')
```

## Supplementary Figure 7A

```{python supp_7a}
supp_fig7a_genes = ['VWF', 'CA4', 'ACKR1', "HEY1", "ABCC9", "TAGLN", "MYH11", "ACTA2", "DCN", "PLP1"]
python_functions.multi_hex_featureplot(tissue_nonimmune, supp_fig7a_genes, ncol=3, cmap=python_functions.blues_cmap, gridsize=200)
```

## Supplementary Figure 7B

```{python supp_7b}
python_functions.hex_plot(tissue_nonimmune, "% Mito", n_genes=False, cmap=python_functions.blues_cmap)
python_functions.hex_plot(tissue_nonimmune, "# Genes", n_genes=True, cmap=python_functions.blues_cmap)
```

## Supplementary Figure 7C

```{python supp_7c}
tissue_nonimmune.obs['Condition'] = [x.capitalize() for x in tissue_nonimmune.obs['condition']]
tissue_nonimmune = tissue_nonimmune.to_anndata()
sc.tl.embedding_density(tissue_nonimmune, groupby='Condition')
sc.pl.embedding_density(tissue_nonimmune, basis='umap', key=f'umap_density_Condition', colorbar_loc=None)
```

## Supplementary Figure 7D

```{python supp_7d_get_data}
stacked_bar_df = python_functions.get_stacked_bar_df(tissue_nonimmune, 'nonimmune')
stacked_bar_order = tissue_nonimmune.obs['umap_name'].cat.categories.values
```

```{r supp_7d_plot}
stacked_bar_order = py$stacked_bar_order[!str_detect(py$stacked_bar_order, 'Doublets')]
plot_clust_perc_by_donor(py$stacked_bar_df, 'nonimmune', cluster_order = stacked_bar_order)
```

